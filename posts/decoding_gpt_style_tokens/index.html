<!doctype html> <html lang=en > <script async src="https://www.googletagmanager.com/gtag/js?id=G-LJE03RZNGT"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LJE03RZNGT'); </script> <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/poole_lanyon.css"> <link rel=stylesheet  href="/css/adjust.css"> <link rel=icon  href="/assets/noto_bread.png"> <title>Decoding GPT-Style Tokens</title> <meta property="og:title" content="Decoding GPT-Style Tokens" /> <meta property="og:description" content="Decoding the GPT-style token representation." /> <link rel=stylesheet  href="https://fonts.googleapis.com/css2?family=Noto+Emoji&display=swap"> <input type=checkbox  class=sidebar-checkbox  id=sidebar-checkbox > <div class=sidebar  id=sidebar > <div class=sidebar-item > <p>theoretically good with computers</a>.</p> </div> <nav class=sidebar-nav > <a class="sidebar-nav-item " href="/">home</a> <a class="sidebar-nav-item " href="/posts/">posts</a> <a class="sidebar-nav-item " href="https://scholar.google.com/citations?user=V-8qwIsAAAAJ&hl=en">publications</a> <a class="sidebar-nav-item " href="https://github.com/mcognetta">github</a> <a class="sidebar-nav-item " href="https://www.linkedin.com/in/mcognetta/">linkedin</a> <a class="sidebar-nav-item " rel=me  href="https://bsky.app/profile/mcognetta.bsky.social">bluesky</a> <a class="sidebar-nav-item " rel=me  href="https://sigmoid.social/@mc">mastodon</a> <a class="sidebar-nav-item " href="https://twitter.com/marco_computers">twitter</a> <a class="sidebar-nav-item " href="assets/mccv.pdf">cv</a> <a class="sidebar-nav-item " href="/tags">all tags</a> </nav> <div class=sidebar-item > <p>&copy; Marco Cognetta.</p> </div> </div> <!-- Wrap is the content to shift when toggling the sidebar. We wrap the content to avoid any CSS collisions with our real content. --> <div class=wrap > <div class=masthead > <div class=container > <h3 class=masthead-title > <a href="/" title=Home >marco cognetta</a> <small>theoretically good with computers</small> </h3> </div> </div> <div class="container content"> <div class=franklin-content ><h1 id=decoding_gpt-style_tokens ><a href="#decoding_gpt-style_tokens" class=header-anchor >Decoding GPT-Style Tokens</a></h1> <p>If you go and look at some tokenizers on HuggingFace, sometimes you will encounter tokens in a vocabulary or merge list that look like gibberish. For example, in the <a href="https://huggingface.co/meta-llama/Meta-Llama-3-8B/blob/main/tokenizer.json">Llama3 tokenizer</a>, you can find tokens like:</p> <pre><code class="julia hljs"><span class=hljs-string >&quot;.conditions&quot;</span>: <span class=hljs-number >99804</span>,
<span class=hljs-string >&quot;ĠHess&quot;</span>: <span class=hljs-number >99805</span>,
<span class=hljs-string >&quot;MEMORY&quot;</span>: <span class=hljs-number >99806</span>,
<span class=hljs-string >&quot;ĠAvalanche&quot;</span>: <span class=hljs-number >99807</span>,
<span class=hljs-string >&quot;()}}Ċ&quot;</span>: <span class=hljs-number >99808</span>,
<span class=hljs-string >&quot;Ġtriplet&quot;</span>: <span class=hljs-number >99809</span>,
<span class=hljs-string >&quot;Ġlabyrinth&quot;</span>: <span class=hljs-number >99810</span>,</code></pre> <p>which are generally meaningful to a human &#40;other than the odd Ġ character&#41;, but also tokens like:</p> <pre><code class="julia hljs"><span class=hljs-string >&quot;Ð¾Ð¶Ðµ&quot;</span>: <span class=hljs-number >103308</span>,
<span class=hljs-string >&quot;å¤ľ&quot;</span>: <span class=hljs-number >103309</span>,
<span class=hljs-string >&quot;ĠÐ½ÑĥÐ¶Ð½Ð¾&quot;</span>: <span class=hljs-number >103310</span>,
<span class=hljs-string >&quot;å½©&quot;</span>: <span class=hljs-number >103311</span>,
<span class=hljs-string >&quot;çĪ±&quot;</span>: <span class=hljs-number >103312</span>,
<span class=hljs-string >&quot;ĠhoÃłn&quot;</span>: <span class=hljs-number >103313</span>,
<span class=hljs-string >&quot;Ã¼nÃ¼&quot;</span>: <span class=hljs-number >103314</span>,</code></pre> <p>which are pretty much meaningless to a human.<sup id="fnref:1"><a href="#fndef:1" class=fnref >[1]</a></sup></p> <p>You may already be aware that the Ġ character <a href="https://en.wikipedia.org/wiki/&#37;C4&#37;A0#Computer_encoding">signifies a space at the beginning of a word</a>, but how about the rest? They come from the fact that GPT-style tokenizers are <em>byte-level</em> tokenizers –- the base character is a byte and we treat the input as the byte sequence of its Unicode UTF8 encoding.</p> <p>So, assuming the token we want to look at represents a valid byte sequence, we&#39;d like to be able to quickly get its original Unicode representation.</p> <h2 id=token_encodingdecoding ><a href="#token_encodingdecoding" class=header-anchor >Token Encoding/Decoding</a></h2> <p>GPT-style tokenizers use bytes as the base representation, but when serializing the tokenizer or pretokenized text &#40;i.e., text that has already been converted into a byte sequence&#41;, they convert the byte sequences to a different format so that we never have to deal with unprintable bytes. For example, if we were to just output the raw bytes represented in ASCII, then some of the bytes would fall into the unprintable control characters range, which would be annoying to deal with in a serialized format. Instead, we map all of the control bytes to some other &#40;non-ASCII, but printable&#41; Unicode character and then when we serialize, all of the output byte representations are printable.</p> <p>GPT <a href="https://github.com/openai/gpt-2/blob/9b63575ef42771a015060c964af2c3da4cf7c8ab/src/encoder.py#L9">implements</a> the byte-to-character mapping like so:</p> <pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">bytes_to_unicode</span>():
    <span class=hljs-string >&quot;&quot;&quot;
    Returns list of utf-8 byte and a corresponding list of unicode strings.
    The reversible bpe codes work on unicode strings.
    This means you need a large # of unicode characters in your vocab if you want to avoid UNKs.
    When you&#x27;re at something like a 10B token dataset you end up needing around 5K for decent coverage.
    This is a signficant percentage of your normal, say, 32K bpe vocab.
    To avoid that, we want lookup tables between utf-8 bytes and unicode strings.
    And avoids mapping to whitespace/control characters the bpe code barfs on.
    &quot;&quot;&quot;</span>
    bs = <span class=hljs-built_in >list</span>(<span class=hljs-built_in >range</span>(<span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;!&quot;</span>), <span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;~&quot;</span>)+<span class=hljs-number >1</span>))+<span class=hljs-built_in >list</span>(<span class=hljs-built_in >range</span>(<span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;¡&quot;</span>), <span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;¬&quot;</span>)+<span class=hljs-number >1</span>))+<span class=hljs-built_in >list</span>(<span class=hljs-built_in >range</span>(<span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;®&quot;</span>), <span class=hljs-built_in >ord</span>(<span class=hljs-string >&quot;ÿ&quot;</span>)+<span class=hljs-number >1</span>))
    cs = bs[:]
    n = <span class=hljs-number >0</span>
    <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> <span class=hljs-built_in >range</span>(<span class=hljs-number >2</span>**<span class=hljs-number >8</span>):
        <span class=hljs-keyword >if</span> b <span class=hljs-keyword >not</span> <span class=hljs-keyword >in</span> bs:
            bs.append(b)
            cs.append(<span class=hljs-number >2</span>**<span class=hljs-number >8</span>+n)
            n += <span class=hljs-number >1</span>
    cs = [<span class=hljs-built_in >chr</span>(n) <span class=hljs-keyword >for</span> n <span class=hljs-keyword >in</span> cs]
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >dict</span>(<span class=hljs-built_in >zip</span>(bs, cs))</code></pre> <p>This first collects a subset of printable characters in <a href="https://www.ascii-code.com/">extended ASCII</a>, converted to their decimal representation, into the list <code>bs</code>. For example, all of the characters between &quot;&#33;&quot; &#40;ASCII decimal 33&#41; and &quot;~&quot; &#40;ASCII decimal 126&#41; are printable and are included in <code>bs</code>, but DEL &#40;ASCII decimal 127&#41; is not printable and not included. <sup id="fnref:2"><a href="#fndef:2" class=fnref >[2]</a></sup> At this point, the list <code>cs</code> is initialized as a copy of <code>bs</code>. Then, we loop back through all 256 possible byte values and, for each byte that is not already in <code>bs</code>, we append it to <code>bs</code> and append the next available Unicode code point &#40;starting from 256&#41; to <code>cs</code>. Finally, <code>cs</code> is converted from code points to their corresponding Unicode characters. Now we have a mapping from bytes to printable characters:</p> <pre><code class="python hljs">{<span class=hljs-number >33</span>: <span class=hljs-string >&#x27;!&#x27;</span>, <span class=hljs-number >34</span>: <span class=hljs-string >&#x27;&quot;&#x27;</span>, <span class=hljs-number >35</span>: <span class=hljs-string >&#x27;#&#x27;</span>, <span class=hljs-number >36</span>: <span class=hljs-string >&#x27;$&#x27;</span>, <span class=hljs-number >37</span>: <span class=hljs-string >&#x27;%&#x27;</span>, <span class=hljs-number >38</span>: <span class=hljs-string >&#x27;&amp;&#x27;</span>, <span class=hljs-number >39</span>: <span class=hljs-string >&quot;&#x27;&quot;</span>, <span class=hljs-number >40</span>: <span class=hljs-string >&#x27;(&#x27;</span>, <span class=hljs-number >41</span>: <span class=hljs-string >&#x27;)&#x27;</span>, <span class=hljs-number >42</span>: <span class=hljs-string >&#x27;*&#x27;</span>, <span class=hljs-number >43</span>: <span class=hljs-string >&#x27;+&#x27;</span>, <span class=hljs-number >44</span>: <span class=hljs-string >&#x27;,&#x27;</span>, <span class=hljs-number >45</span>: <span class=hljs-string >&#x27;-&#x27;</span>, <span class=hljs-number >46</span>: <span class=hljs-string >&#x27;.&#x27;</span>, <span class=hljs-number >47</span>: <span class=hljs-string >&#x27;/&#x27;</span>, <span class=hljs-number >48</span>: <span class=hljs-string >&#x27;0&#x27;</span>, <span class=hljs-number >49</span>: <span class=hljs-string >&#x27;1&#x27;</span>, <span class=hljs-number >50</span>: <span class=hljs-string >&#x27;2&#x27;</span>, <span class=hljs-number >51</span>: <span class=hljs-string >&#x27;3&#x27;</span>, <span class=hljs-number >52</span>: <span class=hljs-string >&#x27;4&#x27;</span>, <span class=hljs-number >53</span>: <span class=hljs-string >&#x27;5&#x27;</span>, <span class=hljs-number >54</span>: <span class=hljs-string >&#x27;6&#x27;</span>, <span class=hljs-number >55</span>: <span class=hljs-string >&#x27;7&#x27;</span>, <span class=hljs-number >56</span>: <span class=hljs-string >&#x27;8&#x27;</span>, <span class=hljs-number >57</span>: <span class=hljs-string >&#x27;9&#x27;</span>, <span class=hljs-number >58</span>: <span class=hljs-string >&#x27;:&#x27;</span>, <span class=hljs-number >59</span>: <span class=hljs-string >&#x27;;&#x27;</span>, <span class=hljs-number >60</span>: <span class=hljs-string >&#x27;&lt;&#x27;</span>, <span class=hljs-number >61</span>: <span class=hljs-string >&#x27;=&#x27;</span>, <span class=hljs-number >62</span>: <span class=hljs-string >&#x27;&gt;&#x27;</span>, <span class=hljs-number >63</span>: <span class=hljs-string >&#x27;?&#x27;</span>, <span class=hljs-number >64</span>: <span class=hljs-string >&#x27;@&#x27;</span>, <span class=hljs-number >65</span>: <span class=hljs-string >&#x27;A&#x27;</span>, <span class=hljs-number >66</span>: <span class=hljs-string >&#x27;B&#x27;</span>, <span class=hljs-number >67</span>: <span class=hljs-string >&#x27;C&#x27;</span>, <span class=hljs-number >68</span>: <span class=hljs-string >&#x27;D&#x27;</span>, <span class=hljs-number >69</span>: <span class=hljs-string >&#x27;E&#x27;</span>, <span class=hljs-number >70</span>: <span class=hljs-string >&#x27;F&#x27;</span>, <span class=hljs-number >71</span>: <span class=hljs-string >&#x27;G&#x27;</span>, <span class=hljs-number >72</span>: <span class=hljs-string >&#x27;H&#x27;</span>, <span class=hljs-number >73</span>: <span class=hljs-string >&#x27;I&#x27;</span>, <span class=hljs-number >74</span>: <span class=hljs-string >&#x27;J&#x27;</span>, <span class=hljs-number >75</span>: <span class=hljs-string >&#x27;K&#x27;</span>, <span class=hljs-number >76</span>: <span class=hljs-string >&#x27;L&#x27;</span>, <span class=hljs-number >77</span>: <span class=hljs-string >&#x27;M&#x27;</span>, <span class=hljs-number >78</span>: <span class=hljs-string >&#x27;N&#x27;</span>, <span class=hljs-number >79</span>: <span class=hljs-string >&#x27;O&#x27;</span>, <span class=hljs-number >80</span>: <span class=hljs-string >&#x27;P&#x27;</span>, <span class=hljs-number >81</span>: <span class=hljs-string >&#x27;Q&#x27;</span>, <span class=hljs-number >82</span>: <span class=hljs-string >&#x27;R&#x27;</span>, <span class=hljs-number >83</span>: <span class=hljs-string >&#x27;S&#x27;</span>, <span class=hljs-number >84</span>: <span class=hljs-string >&#x27;T&#x27;</span>, <span class=hljs-number >85</span>: <span class=hljs-string >&#x27;U&#x27;</span>, <span class=hljs-number >86</span>: <span class=hljs-string >&#x27;V&#x27;</span>, <span class=hljs-number >87</span>: <span class=hljs-string >&#x27;W&#x27;</span>, <span class=hljs-number >88</span>: <span class=hljs-string >&#x27;X&#x27;</span>, <span class=hljs-number >89</span>: <span class=hljs-string >&#x27;Y&#x27;</span>, <span class=hljs-number >90</span>: <span class=hljs-string >&#x27;Z&#x27;</span>, <span class=hljs-number >91</span>: <span class=hljs-string >&#x27;[&#x27;</span>, <span class=hljs-number >92</span>: <span class=hljs-string >&#x27;\\&#x27;</span>, <span class=hljs-number >93</span>: <span class=hljs-string >&#x27;]&#x27;</span>, <span class=hljs-number >94</span>: <span class=hljs-string >&#x27;^&#x27;</span>, <span class=hljs-number >95</span>: <span class=hljs-string >&#x27;_&#x27;</span>, <span class=hljs-number >96</span>: <span class=hljs-string >&#x27;`&#x27;</span>, <span class=hljs-number >97</span>: <span class=hljs-string >&#x27;a&#x27;</span>, <span class=hljs-number >98</span>: <span class=hljs-string >&#x27;b&#x27;</span>, <span class=hljs-number >99</span>: <span class=hljs-string >&#x27;c&#x27;</span>, <span class=hljs-number >100</span>: <span class=hljs-string >&#x27;d&#x27;</span>, <span class=hljs-number >101</span>: <span class=hljs-string >&#x27;e&#x27;</span>, <span class=hljs-number >102</span>: <span class=hljs-string >&#x27;f&#x27;</span>, <span class=hljs-number >103</span>: <span class=hljs-string >&#x27;g&#x27;</span>, <span class=hljs-number >104</span>: <span class=hljs-string >&#x27;h&#x27;</span>, <span class=hljs-number >105</span>: <span class=hljs-string >&#x27;i&#x27;</span>, <span class=hljs-number >106</span>: <span class=hljs-string >&#x27;j&#x27;</span>, <span class=hljs-number >107</span>: <span class=hljs-string >&#x27;k&#x27;</span>, <span class=hljs-number >108</span>: <span class=hljs-string >&#x27;l&#x27;</span>, <span class=hljs-number >109</span>: <span class=hljs-string >&#x27;m&#x27;</span>, <span class=hljs-number >110</span>: <span class=hljs-string >&#x27;n&#x27;</span>, <span class=hljs-number >111</span>: <span class=hljs-string >&#x27;o&#x27;</span>, <span class=hljs-number >112</span>: <span class=hljs-string >&#x27;p&#x27;</span>, <span class=hljs-number >113</span>: <span class=hljs-string >&#x27;q&#x27;</span>, <span class=hljs-number >114</span>: <span class=hljs-string >&#x27;r&#x27;</span>, <span class=hljs-number >115</span>: <span class=hljs-string >&#x27;s&#x27;</span>, <span class=hljs-number >116</span>: <span class=hljs-string >&#x27;t&#x27;</span>, <span class=hljs-number >117</span>: <span class=hljs-string >&#x27;u&#x27;</span>, <span class=hljs-number >118</span>: <span class=hljs-string >&#x27;v&#x27;</span>, <span class=hljs-number >119</span>: <span class=hljs-string >&#x27;w&#x27;</span>, <span class=hljs-number >120</span>: <span class=hljs-string >&#x27;x&#x27;</span>, <span class=hljs-number >121</span>: <span class=hljs-string >&#x27;y&#x27;</span>, <span class=hljs-number >122</span>: <span class=hljs-string >&#x27;z&#x27;</span>, <span class=hljs-number >123</span>: <span class=hljs-string >&#x27;{&#x27;</span>, <span class=hljs-number >124</span>: <span class=hljs-string >&#x27;|&#x27;</span>, <span class=hljs-number >125</span>: <span class=hljs-string >&#x27;}&#x27;</span>, <span class=hljs-number >126</span>: <span class=hljs-string >&#x27;~&#x27;</span>, <span class=hljs-number >161</span>: <span class=hljs-string >&#x27;¡&#x27;</span>, <span class=hljs-number >162</span>: <span class=hljs-string >&#x27;¢&#x27;</span>, <span class=hljs-number >163</span>: <span class=hljs-string >&#x27;£&#x27;</span>, <span class=hljs-number >164</span>: <span class=hljs-string >&#x27;¤&#x27;</span>, <span class=hljs-number >165</span>: <span class=hljs-string >&#x27;¥&#x27;</span>, <span class=hljs-number >166</span>: <span class=hljs-string >&#x27;¦&#x27;</span>, <span class=hljs-number >167</span>: <span class=hljs-string >&#x27;§&#x27;</span>, <span class=hljs-number >168</span>: <span class=hljs-string >&#x27;¨&#x27;</span>, <span class=hljs-number >169</span>: <span class=hljs-string >&#x27;©&#x27;</span>, <span class=hljs-number >170</span>: <span class=hljs-string >&#x27;ª&#x27;</span>, <span class=hljs-number >171</span>: <span class=hljs-string >&#x27;«&#x27;</span>, <span class=hljs-number >172</span>: <span class=hljs-string >&#x27;¬&#x27;</span>, <span class=hljs-number >174</span>: <span class=hljs-string >&#x27;®&#x27;</span>, <span class=hljs-number >175</span>: <span class=hljs-string >&#x27;¯&#x27;</span>, <span class=hljs-number >176</span>: <span class=hljs-string >&#x27;°&#x27;</span>, <span class=hljs-number >177</span>: <span class=hljs-string >&#x27;±&#x27;</span>, <span class=hljs-number >178</span>: <span class=hljs-string >&#x27;²&#x27;</span>, <span class=hljs-number >179</span>: <span class=hljs-string >&#x27;³&#x27;</span>, <span class=hljs-number >180</span>: <span class=hljs-string >&#x27;´&#x27;</span>, <span class=hljs-number >181</span>: <span class=hljs-string >&#x27;µ&#x27;</span>, <span class=hljs-number >182</span>: <span class=hljs-string >&#x27;¶&#x27;</span>, <span class=hljs-number >183</span>: <span class=hljs-string >&#x27;·&#x27;</span>, <span class=hljs-number >184</span>: <span class=hljs-string >&#x27;¸&#x27;</span>, <span class=hljs-number >185</span>: <span class=hljs-string >&#x27;¹&#x27;</span>, <span class=hljs-number >186</span>: <span class=hljs-string >&#x27;º&#x27;</span>, <span class=hljs-number >187</span>: <span class=hljs-string >&#x27;»&#x27;</span>, <span class=hljs-number >188</span>: <span class=hljs-string >&#x27;¼&#x27;</span>, <span class=hljs-number >189</span>: <span class=hljs-string >&#x27;½&#x27;</span>, <span class=hljs-number >190</span>: <span class=hljs-string >&#x27;¾&#x27;</span>, <span class=hljs-number >191</span>: <span class=hljs-string >&#x27;¿&#x27;</span>, <span class=hljs-number >192</span>: <span class=hljs-string >&#x27;À&#x27;</span>, <span class=hljs-number >193</span>: <span class=hljs-string >&#x27;Á&#x27;</span>, <span class=hljs-number >194</span>: <span class=hljs-string >&#x27;Â&#x27;</span>, <span class=hljs-number >195</span>: <span class=hljs-string >&#x27;Ã&#x27;</span>, <span class=hljs-number >196</span>: <span class=hljs-string >&#x27;Ä&#x27;</span>, <span class=hljs-number >197</span>: <span class=hljs-string >&#x27;Å&#x27;</span>, <span class=hljs-number >198</span>: <span class=hljs-string >&#x27;Æ&#x27;</span>, <span class=hljs-number >199</span>: <span class=hljs-string >&#x27;Ç&#x27;</span>, <span class=hljs-number >200</span>: <span class=hljs-string >&#x27;È&#x27;</span>, <span class=hljs-number >201</span>: <span class=hljs-string >&#x27;É&#x27;</span>, <span class=hljs-number >202</span>: <span class=hljs-string >&#x27;Ê&#x27;</span>, <span class=hljs-number >203</span>: <span class=hljs-string >&#x27;Ë&#x27;</span>, <span class=hljs-number >204</span>: <span class=hljs-string >&#x27;Ì&#x27;</span>, <span class=hljs-number >205</span>: <span class=hljs-string >&#x27;Í&#x27;</span>, <span class=hljs-number >206</span>: <span class=hljs-string >&#x27;Î&#x27;</span>, <span class=hljs-number >207</span>: <span class=hljs-string >&#x27;Ï&#x27;</span>, <span class=hljs-number >208</span>: <span class=hljs-string >&#x27;Ð&#x27;</span>, <span class=hljs-number >209</span>: <span class=hljs-string >&#x27;Ñ&#x27;</span>, <span class=hljs-number >210</span>: <span class=hljs-string >&#x27;Ò&#x27;</span>, <span class=hljs-number >211</span>: <span class=hljs-string >&#x27;Ó&#x27;</span>, <span class=hljs-number >212</span>: <span class=hljs-string >&#x27;Ô&#x27;</span>, <span class=hljs-number >213</span>: <span class=hljs-string >&#x27;Õ&#x27;</span>, <span class=hljs-number >214</span>: <span class=hljs-string >&#x27;Ö&#x27;</span>, <span class=hljs-number >215</span>: <span class=hljs-string >&#x27;×&#x27;</span>, <span class=hljs-number >216</span>: <span class=hljs-string >&#x27;Ø&#x27;</span>, <span class=hljs-number >217</span>: <span class=hljs-string >&#x27;Ù&#x27;</span>, <span class=hljs-number >218</span>: <span class=hljs-string >&#x27;Ú&#x27;</span>, <span class=hljs-number >219</span>: <span class=hljs-string >&#x27;Û&#x27;</span>, <span class=hljs-number >220</span>: <span class=hljs-string >&#x27;Ü&#x27;</span>, <span class=hljs-number >221</span>: <span class=hljs-string >&#x27;Ý&#x27;</span>, <span class=hljs-number >222</span>: <span class=hljs-string >&#x27;Þ&#x27;</span>, <span class=hljs-number >223</span>: <span class=hljs-string >&#x27;ß&#x27;</span>, <span class=hljs-number >224</span>: <span class=hljs-string >&#x27;à&#x27;</span>, <span class=hljs-number >225</span>: <span class=hljs-string >&#x27;á&#x27;</span>, <span class=hljs-number >226</span>: <span class=hljs-string >&#x27;â&#x27;</span>, <span class=hljs-number >227</span>: <span class=hljs-string >&#x27;ã&#x27;</span>, <span class=hljs-number >228</span>: <span class=hljs-string >&#x27;ä&#x27;</span>, <span class=hljs-number >229</span>: <span class=hljs-string >&#x27;å&#x27;</span>, <span class=hljs-number >230</span>: <span class=hljs-string >&#x27;æ&#x27;</span>, <span class=hljs-number >231</span>: <span class=hljs-string >&#x27;ç&#x27;</span>, <span class=hljs-number >232</span>: <span class=hljs-string >&#x27;è&#x27;</span>, <span class=hljs-number >233</span>: <span class=hljs-string >&#x27;é&#x27;</span>, <span class=hljs-number >234</span>: <span class=hljs-string >&#x27;ê&#x27;</span>, <span class=hljs-number >235</span>: <span class=hljs-string >&#x27;ë&#x27;</span>, <span class=hljs-number >236</span>: <span class=hljs-string >&#x27;ì&#x27;</span>, <span class=hljs-number >237</span>: <span class=hljs-string >&#x27;í&#x27;</span>, <span class=hljs-number >238</span>: <span class=hljs-string >&#x27;î&#x27;</span>, <span class=hljs-number >239</span>: <span class=hljs-string >&#x27;ï&#x27;</span>, <span class=hljs-number >240</span>: <span class=hljs-string >&#x27;ð&#x27;</span>, <span class=hljs-number >241</span>: <span class=hljs-string >&#x27;ñ&#x27;</span>, <span class=hljs-number >242</span>: <span class=hljs-string >&#x27;ò&#x27;</span>, <span class=hljs-number >243</span>: <span class=hljs-string >&#x27;ó&#x27;</span>, <span class=hljs-number >244</span>: <span class=hljs-string >&#x27;ô&#x27;</span>, <span class=hljs-number >245</span>: <span class=hljs-string >&#x27;õ&#x27;</span>, <span class=hljs-number >246</span>: <span class=hljs-string >&#x27;ö&#x27;</span>, <span class=hljs-number >247</span>: <span class=hljs-string >&#x27;÷&#x27;</span>, <span class=hljs-number >248</span>: <span class=hljs-string >&#x27;ø&#x27;</span>, <span class=hljs-number >249</span>: <span class=hljs-string >&#x27;ù&#x27;</span>, <span class=hljs-number >250</span>: <span class=hljs-string >&#x27;ú&#x27;</span>, <span class=hljs-number >251</span>: <span class=hljs-string >&#x27;û&#x27;</span>, <span class=hljs-number >252</span>: <span class=hljs-string >&#x27;ü&#x27;</span>, <span class=hljs-number >253</span>: <span class=hljs-string >&#x27;ý&#x27;</span>, <span class=hljs-number >254</span>: <span class=hljs-string >&#x27;þ&#x27;</span>, <span class=hljs-number >255</span>: <span class=hljs-string >&#x27;ÿ&#x27;</span>, <span class=hljs-number >0</span>: <span class=hljs-string >&#x27;Ā&#x27;</span>, <span class=hljs-number >1</span>: <span class=hljs-string >&#x27;ā&#x27;</span>, <span class=hljs-number >2</span>: <span class=hljs-string >&#x27;Ă&#x27;</span>, <span class=hljs-number >3</span>: <span class=hljs-string >&#x27;ă&#x27;</span>, <span class=hljs-number >4</span>: <span class=hljs-string >&#x27;Ą&#x27;</span>, <span class=hljs-number >5</span>: <span class=hljs-string >&#x27;ą&#x27;</span>, <span class=hljs-number >6</span>: <span class=hljs-string >&#x27;Ć&#x27;</span>, <span class=hljs-number >7</span>: <span class=hljs-string >&#x27;ć&#x27;</span>, <span class=hljs-number >8</span>: <span class=hljs-string >&#x27;Ĉ&#x27;</span>, <span class=hljs-number >9</span>: <span class=hljs-string >&#x27;ĉ&#x27;</span>, <span class=hljs-number >10</span>: <span class=hljs-string >&#x27;Ċ&#x27;</span>, <span class=hljs-number >11</span>: <span class=hljs-string >&#x27;ċ&#x27;</span>, <span class=hljs-number >12</span>: <span class=hljs-string >&#x27;Č&#x27;</span>, <span class=hljs-number >13</span>: <span class=hljs-string >&#x27;č&#x27;</span>, <span class=hljs-number >14</span>: <span class=hljs-string >&#x27;Ď&#x27;</span>, <span class=hljs-number >15</span>: <span class=hljs-string >&#x27;ď&#x27;</span>, <span class=hljs-number >16</span>: <span class=hljs-string >&#x27;Đ&#x27;</span>, <span class=hljs-number >17</span>: <span class=hljs-string >&#x27;đ&#x27;</span>, <span class=hljs-number >18</span>: <span class=hljs-string >&#x27;Ē&#x27;</span>, <span class=hljs-number >19</span>: <span class=hljs-string >&#x27;ē&#x27;</span>, <span class=hljs-number >20</span>: <span class=hljs-string >&#x27;Ĕ&#x27;</span>, <span class=hljs-number >21</span>: <span class=hljs-string >&#x27;ĕ&#x27;</span>, <span class=hljs-number >22</span>: <span class=hljs-string >&#x27;Ė&#x27;</span>, <span class=hljs-number >23</span>: <span class=hljs-string >&#x27;ė&#x27;</span>, <span class=hljs-number >24</span>: <span class=hljs-string >&#x27;Ę&#x27;</span>, <span class=hljs-number >25</span>: <span class=hljs-string >&#x27;ę&#x27;</span>, <span class=hljs-number >26</span>: <span class=hljs-string >&#x27;Ě&#x27;</span>, <span class=hljs-number >27</span>: <span class=hljs-string >&#x27;ě&#x27;</span>, <span class=hljs-number >28</span>: <span class=hljs-string >&#x27;Ĝ&#x27;</span>, <span class=hljs-number >29</span>: <span class=hljs-string >&#x27;ĝ&#x27;</span>, <span class=hljs-number >30</span>: <span class=hljs-string >&#x27;Ğ&#x27;</span>, <span class=hljs-number >31</span>: <span class=hljs-string >&#x27;ğ&#x27;</span>, <span class=hljs-number >32</span>: <span class=hljs-string >&#x27;Ġ&#x27;</span>, <span class=hljs-number >127</span>: <span class=hljs-string >&#x27;ġ&#x27;</span>, <span class=hljs-number >128</span>: <span class=hljs-string >&#x27;Ģ&#x27;</span>, <span class=hljs-number >129</span>: <span class=hljs-string >&#x27;ģ&#x27;</span>, <span class=hljs-number >130</span>: <span class=hljs-string >&#x27;Ĥ&#x27;</span>, <span class=hljs-number >131</span>: <span class=hljs-string >&#x27;ĥ&#x27;</span>, <span class=hljs-number >132</span>: <span class=hljs-string >&#x27;Ħ&#x27;</span>, <span class=hljs-number >133</span>: <span class=hljs-string >&#x27;ħ&#x27;</span>, <span class=hljs-number >134</span>: <span class=hljs-string >&#x27;Ĩ&#x27;</span>, <span class=hljs-number >135</span>: <span class=hljs-string >&#x27;ĩ&#x27;</span>, <span class=hljs-number >136</span>: <span class=hljs-string >&#x27;Ī&#x27;</span>, <span class=hljs-number >137</span>: <span class=hljs-string >&#x27;ī&#x27;</span>, <span class=hljs-number >138</span>: <span class=hljs-string >&#x27;Ĭ&#x27;</span>, <span class=hljs-number >139</span>: <span class=hljs-string >&#x27;ĭ&#x27;</span>, <span class=hljs-number >140</span>: <span class=hljs-string >&#x27;Į&#x27;</span>, <span class=hljs-number >141</span>: <span class=hljs-string >&#x27;į&#x27;</span>, <span class=hljs-number >142</span>: <span class=hljs-string >&#x27;İ&#x27;</span>, <span class=hljs-number >143</span>: <span class=hljs-string >&#x27;ı&#x27;</span>, <span class=hljs-number >144</span>: <span class=hljs-string >&#x27;Ĳ&#x27;</span>, <span class=hljs-number >145</span>: <span class=hljs-string >&#x27;ĳ&#x27;</span>, <span class=hljs-number >146</span>: <span class=hljs-string >&#x27;Ĵ&#x27;</span>, <span class=hljs-number >147</span>: <span class=hljs-string >&#x27;ĵ&#x27;</span>, <span class=hljs-number >148</span>: <span class=hljs-string >&#x27;Ķ&#x27;</span>, <span class=hljs-number >149</span>: <span class=hljs-string >&#x27;ķ&#x27;</span>, <span class=hljs-number >150</span>: <span class=hljs-string >&#x27;ĸ&#x27;</span>, <span class=hljs-number >151</span>: <span class=hljs-string >&#x27;Ĺ&#x27;</span>, <span class=hljs-number >152</span>: <span class=hljs-string >&#x27;ĺ&#x27;</span>, <span class=hljs-number >153</span>: <span class=hljs-string >&#x27;Ļ&#x27;</span>, <span class=hljs-number >154</span>: <span class=hljs-string >&#x27;ļ&#x27;</span>, <span class=hljs-number >155</span>: <span class=hljs-string >&#x27;Ľ&#x27;</span>, <span class=hljs-number >156</span>: <span class=hljs-string >&#x27;ľ&#x27;</span>, <span class=hljs-number >157</span>: <span class=hljs-string >&#x27;Ŀ&#x27;</span>, <span class=hljs-number >158</span>: <span class=hljs-string >&#x27;ŀ&#x27;</span>, <span class=hljs-number >159</span>: <span class=hljs-string >&#x27;Ł&#x27;</span>, <span class=hljs-number >160</span>: <span class=hljs-string >&#x27;ł&#x27;</span>, <span class=hljs-number >173</span>: <span class=hljs-string >&#x27;Ń&#x27;</span>}</code></pre>
<p>Note that in the table above, the token &quot;Ġ&quot; corresponds to the byte value 32, which is the space character in ASCII &#40;decimal 32&#41; and explains its use as the leading space character in a token.</p>
<p>The byte mapping and its inverse are saved for future use:</p>
<pre><code class="python hljs">byte_encoder = bytes_to_unicode()
byte_decoder = {v: k <span class=hljs-keyword >for</span> k, v <span class=hljs-keyword >in</span> byte_encoder.items()}</code></pre>
<p>When given a token to serialize, we convert it to a byte sequence and map it to the corresponding character sequence via the byte encoding.</p>
<pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">encode_token</span>(<span class=hljs-params >token: <span class=hljs-built_in >str</span></span>) -&gt; <span class=hljs-built_in >str</span>:
    <span class=hljs-keyword >return</span> <span class=hljs-string >&#x27;&#x27;</span>.join(byte_encoder[b] <span class=hljs-keyword >for</span> b <span class=hljs-keyword >in</span> token.encode(<span class=hljs-string >&#x27;utf8&#x27;</span>))

encode_token(<span class=hljs-string >&#x27; нужно&#x27;</span>) <span class=hljs-comment ># -&gt; &quot;ĠÐ½ÑĥÐ¶Ð½Ð¾&quot;</span></code></pre>
<p>To recover the token from the serialized form, we do the opposite –- get the byte associated with each token, construct a byte sequence, and reinterpret it as UTF8.</p>
<pre><code class="python hljs"><span class=hljs-keyword >def</span> <span class="hljs-title function_">decode_token</span>(<span class=hljs-params >encoded_token: <span class=hljs-built_in >str</span></span>) -&gt; <span class=hljs-built_in >str</span>:
    <span class=hljs-keyword >return</span> <span class=hljs-built_in >bytes</span>(byte_decoder[c] <span class=hljs-keyword >for</span> c <span class=hljs-keyword >in</span> encoded_token).decode(<span class=hljs-string >&#x27;utf8&#x27;</span>)
    
decode_token(<span class=hljs-string >&quot;ĠÐ½ÑĥÐ¶Ð½Ð¾&quot;</span>) <span class=hljs-comment ># -&gt; &#x27; нужно&#x27;</span></code></pre>
<p>As far as I can tell, the rationale behind this token encoding/decoding is to avoid unprintable or difficult-to-parse characters from the tokenizer representation while keeping most human readable &#40;particularly, the English alphabet, some punctuation, and numbers&#41; intact to preserve English tokens where possible. </p>
<p>It isn&#39;t clear to me why the final mapping was produced algorithmically, though. Since there are only 256 bytes and almost all of the non-control character ASCII tokens are already captured by the initial <code>bs</code> list &#40;just 36 non-control characters are absent&#41;, it seems like this mapping could have just been defined by hand. But, if it works, it works, and I am sure OpenAI had bigger fish to fry at the time.</p>
<h2 id=huggingface_tokenizers_implementation ><a href="#huggingface_tokenizers_implementation" class=header-anchor >HuggingFace Tokenizers&#39; Implementation</a></h2>
<p>This token encoding is present in the HuggingFace Tokenizers library, via the <code>ByteLevel</code> decoder. The <code>byte_to_unicode&#40;&#41;</code> function is reimplemented <a href="https://github.com/huggingface/tokenizers/blob/ecad3f18a3e340635f5393cfb22cf70d3502f64a/tokenizers/src/pre_tokenizers/byte_level.rs#L15">here</a> and is utilized in the <code>ByteLevel</code> normalizer <a href="https://github.com/huggingface/tokenizers/blob/ecad3f18a3e340635f5393cfb22cf70d3502f64a/tokenizers/src/normalizers/byte_level.rs#L41">here</a>. One potential edge case is that the current <code>ByteLevel</code> implementation assumes that the exact GPT byte-to-character mapping is used by the tokenizer. However, one could easily define another byte-to-character mapping which would then not be supported by HuggingFace &#40;though I have no examples of this in practice, and there may be some workaround within Tokenizers that I am unaware of&#41;. </p>
<hr />
<p><table class=fndef  id="fndef:1">
    <tr>
        <td class=fndef-backref ><a href="#fnref:1">[1]</a>
        <td class=fndef-content >Not all tokenizers will suffer from this issue. For example, tokenizers that are built on SentencePiece, which uses Unicode characters, not bytes, for the base representation will always have human-readable tokens. These tokenizers use byte-level fallbacks to encode OOV tokens, but such tokens do not appear in the vocabulary list. An example is the <a href="https://huggingface.co/meta-llama/Llama-2-7b-hf/blob/main/tokenizer.json">Llama2 tokenizer</a>.
    
</table>
 <table class=fndef  id="fndef:2">
    <tr>
        <td class=fndef-backref ><a href="#fnref:2">[2]</a>
        <td class=fndef-content >However, &quot;‰&quot; &#40;ASCII decimal 137&#41; <em>is</em> printable, but not included in <code>bs</code>, hence why we say a <code>bs</code> is seeded with a  <em>subset</em> of printable characters.
    
</table>
</p>
<div class=page-foot >
  <div class=copyright >
    &copy; Marco Cognetta. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
  </div>
</div>
</div> 

</div>  
</div> 


    
<script src="/libs/highlight/highlight.min.js"></script>


<link rel=stylesheet  href="/libs/highlight/github.css">

<script>
  document.addEventListener("DOMContentLoaded", (event) => {
    hljs.configure({tabReplace: '    '});
    hljs.highlightAll();
  });
</script>

<label for=sidebar-checkbox  class=sidebar-toggle ></label>